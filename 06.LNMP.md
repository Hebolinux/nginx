# LNMP

### 架构概述

Nginx服务无法处理动态请求，因此，当Nginx收到用户发起的http请求时，如果是静态资源请求则由Nginx直接返回，如果是动态请求，Nginx会通过FastCGI协议将请求转交给后端的PHP程序进行处理

```diff
客户端   http://example.com/index.php    Nginx    FastCGI协议      PHP
浏览器 -------------------------------->  代理  ----------------> 服务端
```

Nginx结合PHP FastCGI运行流程

```diff
                      |                PHP Server                 |
Client    FastCGI     |fastcgi <-> php-fpm <-> wrapper -> php解析器|   Access DB
Nginx  -------------> |          php-fpm.conf              php.ini|-------------> MySQL
```

1. 用户通过http协议发起请求，请求抵达Nginx
2. Nginx根据用户的请求进行`location`规则匹配
3. `location`匹配到请求是静态，则由Nginx读取本地直接返回
4. `location`匹配到请求是动态，则由Nginx将请求转发给FastCGI协议
5. FastCGI收到后将请求交给`php-fpm`管理进程，`php-fpm`管理进程收到请求后调用具体的工作进程`wrapper`
6. `wrapper`进程调用php程序进行解析，如果只是解析代码，php解析器直接返回
7. 如果有查询数据库操作，则由php连接数据库发起查询操作
8. 最终数据由mysql -> php -> php-fpm -> fastcgi -> nginx -> http -> user

> **补充**

`php-fpm`仅作为PHP的管理端，用于管理PHP程序，不做任何事件处理。`php-fpm`管理进程由`php-fpm.conf`配置文件控制，此管理文件可以控制PHP可以起多少个工作进程。PHP允许上传的最大文件或是否允许上传恶意文件都由PHP解析器控制，PHP解析器的配置文件则是`php.ini`。PHP要连接数据库需要安装专门的连接模块，才能够正常连接数据库。



### LNMP安装

1. 使用[官方仓库](http://nginx.org/en/linux_packages.html)安装nginx（以Ubuntu示例）

```shell
# sudo apt install curl gnupg2 ca-certificates lsb-release

# echo "deb http://nginx.org/packages/ubuntu `lsb_release -cs` nginx" \
    | sudo tee /etc/apt/sources.list.d/nginx.list
    
# curl -fsSL https://nginx.org/keys/nginx_signing.key | sudo apt-key add -
# sudo apt update
# sudo apt install nginx
```

