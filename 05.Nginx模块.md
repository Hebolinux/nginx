# Nginx常用模块

nginx的模块语法及扩展都可以在nginx的官网查询，以下模块为比较常见的模块解析

[nginx官方文档](http://nginx.org/en/docs/)

### Nginx目录索引

`ngx_http_autoindex_module`处理以斜杠字符('/')结尾的请求，并生成一个目录列表。当`ngx_http_index_module`模块找不到索引文件时，通常会将请求传递给`ngx_http_autoindex_module`模块

示例：`autoindex`模块配置

```shell
server {
        listen 80;
        server_name ubuntu.example.com;

        location / {
                root /usr/share/nginx/html/code;	#上传一些目录或文件到此目录中
                #index index.html index.htm;
                autoindex on;
        }
}
```

[autoindex模块官方文档](http://nginx.org/en/docs/http/ngx_http_autoindex_module.html)

> **问题**

1. 目录索引中文乱码

```shell
server {
	listen 80;
	server_name ubuntu.example.com;
	charset utf-8,gbk;								#添加支持的字符集

	...
}
```

2. 网页显示的文件大小单位调整

```shell
location / {
                root /usr/share/nginx/html/code;
                autoindex on;
                autoindex_exact_size off;			#在目录列表中显示确切的大小
                autoindex_localtime on;				#指定目录列表的时间戳是本地时区还是UTC时区，UTC表示文件原本的时间戳
        }
```

> **补充**

- 在配置文件中使用`autoindex`模块时，在`root`目录下应尽量减少`index.html`文件的存在，因为即便注释`index`模块，浏览器默认也会解析`index.html`文件

- root：`locataion /`语法中的"/"号表示"根目录"，这个"根目录"是由`location`块中的`root`定义的，例如`root /data`表示设置nginx的"根目录"为`/data`，通过浏览器访问web服务时也是直接访问的`/data`路径，如果此时将`location /`设置为`location /code`，再通过浏览器访问web服务时就需要输入完整路径`http://localhost/code/`（在`localhost`后面加上`code`是为了匹配`location`），而`localhost/code/`表示在访问"根目录"下的`code`目录，此时访问web服务的完整路径应该是`/data/code`
- alias：`alias`解决了访问根目录下的子目录的问题，只要能够满足`location`的匹配条件，就能够访问`alias`所定义的根目录，例如`location /code`且`alias /data`，此时通过浏览器访问`http://localhost/code`时，实际访问web服务的完整路径也是`/data`

> **nginx常见配置**

```shell
server {
	listen 80;
	server_name ubuntu.example.com;
	charset utf-8,gbk;

	location / {									#此URL用于展示首页HTML
		root /usr/share/nginx/html/code;
		index index.html index.htm;
	}

	location /game {								#展示下载文件
		alias /tmp/html/code;
		autoindex on;
		autoindex_exact_size off;
		autoindex_localtime on;
	}
}
```



###　Nginx状态监控

`ngx_http_stub_status_module`提供对基本状态信息的访问。 此模块不是默认构建的，它应该使用`- with-http_stub_status_module`配置参数来启用（使用yum安装nginx默认安装）

示例：nginx的`stub_status`模块

```shell
location = /basic_status {
                stub_status;
        }
```

将此`location`块补充到`server`块中即可，通过访问浏览器地址`http://localhost/basic_status`可以查看nginx连接状态

```shell
Active connections: 2 
server accepts handled requests
 6 6 4 
Reading: 0 Writing: 1 Waiting: 1
```

关于这些状态的解析，可以查看[stub_status模块官方文档](http://nginx.org/en/docs/http/ngx_http_stub_status_module.html)，需要说明的是，nginx默认情况下保持长连接，也就是一次连接，多次请求与响应，如果次数不断刷新浏览器页面则会发现`requests`会不断更新。也可以暂时关闭长连接查看效果

```shell
# vim /etc/nginx/nginx.conf
...
    #keepalive_timeout  65;							#65s没有活动则断开连接
    keepalive_timeout 0;							#等同于不保持长连接状态
...
# systemctl reload nginx
```



### Nginx访问控制

该`ngx_http_access_module`模块允许限制对某些客户端地址的访问，[access模块官方文档](http://nginx.org/en/docs/http/ngx_http_access_module.html)

示例：拒绝指定地址访问

```shell
location = /basic_status {
                stub_status;
                deny 172.20.1.59/32;
                allow all;
        }
```

`deny`为拒绝，`allow`为允许，在`access`模块中允许使用网段或具体的地址，也可以使用关键词`all`表示所有地址，`access`模块的匹配规则是从上到下、逐一匹配。对于nginx的ip或网段的访问控制是可以通过代理服务器的方式突破限制的



### Nginx资源限制

`ngx_http_auth_basic_module`允许通过使用http基本身份验证协议验证用户名和密码来限制对资源的访问，通常将`auth_basic`模块和`access`模块联用，访问web服务之前则需要先通过帐号密码的验证，再通过IP地址的筛选后才能成功访问



### Nginx访问限制

### Nginx Location

